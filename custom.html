<html>

  <head>
    <title>Embedding Elm in HTML!</title>
    <script type="text/javascript" src="/vendor/rsvp.js"></script>
    <script type="text/javascript" src="/vendor/route-recognizer.js"></script>
    <script type="text/javascript" src="/vendor/router.js"></script>

    <script type="text/javascript" src="build/Main.js"></script>
  </head>

  <body>

    <script>
      var result = {
        id: "",
        isStart: false,
        isDrop: false,
        isEnd: false,
        isMulti: false,
        startX: 0,
        startY: 0,
        endX: 0,
        endY: 0
      };

      var board = Elm.fullscreen(Elm.Main, {
        dragstart: result,
        dragend: result,
        drop: result,
        globalKeyDown: 0
      });

      document.addEventListener('keydown', function(e) {
          board.ports.globalKeyDown.send(e.keyCode);
      }, true);

      board.ports.focus.subscribe(function(selector) {
          setTimeout(function() {
              var nodes = document.querySelectorAll(selector);
              if (nodes.length === 1 && document.activeElement !== nodes[0]) {
                  nodes[0].focus()
                  nodes[0].setSelectionRange(0, nodes[0].value.length)
              }
          }, 50);
      });

      board.ports.transitionToRoute.subscribe(function(url) {
        console.log('updating url with', url);
        window.history.pushState({}, '', url);
      });

      var links = document.querySelectorAll("a[href='#']");

      Array.prototype.slice.apply(links).forEach(function(node) {
          node.addEventListener("click", function(e) {
            e.preventDefault();
          });
      });

      function sendPort(port, result) {
        console.log('sending ', port, result);

        result.isStart = result.isEnd = result.isDrop = false;

        switch(port) {
          case "dragstart":
            result.isStart = true;
            break;
          case "dragend":
            result.isEnd = true;
            break;
          case "drop":
            result.isDrop = true;
            break;
        }

        board.ports[port].send(result);
      }

      setTimeout(function() {
        var container = document.querySelector("main");
        container.addEventListener('dragstart', function(e) {

          result.id = e.target.id;
          result.startX = event.clientX;
          result.startY = event.clientY;

          if(e.metaKey) {
            result.isMulti = true;
          } else {
            result.isMulti = false;
          }

          e.dataTransfer.dropEffect = 'move';

          sendPort('dragstart', result);
        });

        container.addEventListener('dragover', function(e) {
          e.preventDefault();
        });

        container.addEventListener('dragend', function(e) {
          sendPort('dragend', result);
        });

        container.addEventListener('drop', function(e) {
          e.stopPropagation();
          result.endX = e.clientX;
          result.endY = e.clientY;

          sendPort('drop', result);
        });
      }, 1000);
      // board.ports.dragstart.send
    </script>
  </body>


</html>
